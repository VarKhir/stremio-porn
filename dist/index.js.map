{"version":3,"sources":["../src/index.js"],"names":["SUPPORTED_METHODS","STATIC_DIR","DEFAULT_ID","ID","process","env","GOONHUB_ID","ENDPOINT","GOONHUB_ENDPOINT","PORT","GOONHUB_PORT","PROXY","GOONHUB_PROXY","HTTPS_PROXY","CACHE","GOONHUB_CACHE","EMAIL","GOONHUB_EMAIL","USENET_STREAMER","GOONHUB_USENET_STREAMER","IS_PROD","NODE_ENV","console","error","chalk","red","exit","parseUserConfig","configStr","standard","replace","decoded","Buffer","from","toString","config","JSON","parse","err","baseClientOptions","proxy","cache","usenetStreamerUrl","adapters","PornClient","getAdapters","availableSites","map","a","DISPLAY_NAME","join","MANIFEST","name","id","version","pkg","description","types","idProperty","dontAnnounce","sorts","getSorts","catalogs","getCatalogs","resources","idPrefixes","getIdPrefixes","email","contactEmail","endpoint","logo","icon","background","filter","$exists","$in","makeMethod","client","methodName","request","cb","response","invokeMethod","gray","Date","toLocaleString","makeMethods","methodNames","reduce","methods","defaultClient","defaultMethods","defaultAddon","Stremio","Server","userClients","userClientKeys","MAX_USER_CLIENTS","getClientForConfig","userConfig","realDebridToken","torboxToken","clientOptions","push","length","oldKey","shift","server","http","createServer","req","res","configMatch","url","match","configuredManifest","configuredAddon","slice","middleware","end","status","manifest","writeHead","stringify","on","values","green","log","listen"],"mappings":"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","sourcesContent":["import http from 'http'\nimport Stremio from 'stremio-addons'\nimport serveStatic from 'serve-static'\nimport chalk from 'chalk'\nimport pkg from '../package.json'\nimport PornClient from './PornClient'\n\n\nconst SUPPORTED_METHODS = [\n  'stream.find', 'meta.find', 'meta.search', 'meta.get',\n]\nconst STATIC_DIR = 'static'\nconst DEFAULT_ID = 'goonhub'\n\nconst ID = process.env.GOONHUB_ID || DEFAULT_ID\nconst ENDPOINT = process.env.GOONHUB_ENDPOINT || 'http://localhost'\nconst PORT = process.env.GOONHUB_PORT || process.env.PORT || '80'\nconst PROXY = process.env.GOONHUB_PROXY || process.env.HTTPS_PROXY\nconst CACHE = process.env.GOONHUB_CACHE || '1'\nconst EMAIL = process.env.GOONHUB_EMAIL || process.env.EMAIL\nconst USENET_STREAMER = process.env.GOONHUB_USENET_STREAMER\nconst IS_PROD = process.env.NODE_ENV === 'production'\n\n\nif (IS_PROD && ID === DEFAULT_ID) {\n  // eslint-disable-next-line no-console\n  console.error(\n    chalk.red(\n      '\\nWhen running in production, a non-default addon identifier must be specified\\n'\n    )\n  )\n  process.exit(1)\n}\n\nfunction parseUserConfig(configStr) {\n  if (!configStr) {\n    return {}\n  }\n\n  try {\n    // Convert URL-safe base64 back to standard base64\n    let standard = configStr.replace(/-/g, '+').replace(/_/g, '/')\n    let decoded = Buffer.from(standard, 'base64').toString('utf8')\n    let config = JSON.parse(decoded)\n    return config || {}\n  } catch (err) {\n    return {}\n  }\n}\n\nlet baseClientOptions = {\n  proxy: PROXY,\n  cache: CACHE,\n  usenetStreamerUrl: USENET_STREAMER,\n}\nlet adapters = PornClient.getAdapters(baseClientOptions)\nlet availableSites = adapters.map((a) => a.DISPLAY_NAME).join(', ')\n\nconst MANIFEST = {\n  name: 'GoonHub',\n  id: ID,\n  version: pkg.version,\n  description: `\\\nTime to unsheathe your sword! \\\nWatch porn videos and webcam streams from ${availableSites}\\\n`,\n  types: ['movie', 'tv'],\n  idProperty: PornClient.ID,\n  dontAnnounce: !IS_PROD,\n  sorts: PornClient.getSorts(baseClientOptions, adapters),\n  catalogs: PornClient.getCatalogs(baseClientOptions, adapters),\n  resources: ['stream', 'meta', 'catalog'],\n  // Stremio manifest allows advertising supported external id prefixes for stream requests\n  idPrefixes: PornClient.getIdPrefixes(baseClientOptions, adapters),\n  // The docs mention `contactEmail`, but the template uses `email`\n  email: EMAIL,\n  contactEmail: EMAIL,\n  endpoint: `${ENDPOINT}/stremioget/stremio/v1`,\n  logo: `${ENDPOINT}/logo.png`,\n  icon: `${ENDPOINT}/logo.png`,\n  background: `${ENDPOINT}/bg.jpg`,\n  // OBSOLETE: used in pre-4.0 stremio instead of idProperty/types\n  filter: {\n    [`query.${PornClient.ID}`]: { $exists: true },\n    'query.type': { $in: ['movie', 'tv'] },\n  },\n}\n\n\nfunction makeMethod(client, methodName) {\n  return async (request, cb) => {\n    let response\n    let error\n\n    try {\n      response = await client.invokeMethod(methodName, request)\n    } catch (err) {\n      error = err\n\n      /* eslint-disable no-console */\n      console.error(\n        // eslint-disable-next-line prefer-template\n        chalk.gray(new Date().toLocaleString()) +\n        ' An error has occurred while processing ' +\n        `the following request to ${methodName}:`\n      )\n      console.error(request)\n      console.error(err)\n      /* eslint-enable no-console */\n    }\n\n    cb(error, response)\n  }\n}\n\nfunction makeMethods(client, methodNames) {\n  return methodNames.reduce((methods, methodName) => {\n    methods[methodName] = makeMethod(client, methodName)\n    return methods\n  }, {})\n}\n\n\nlet defaultClient = new PornClient(baseClientOptions)\nlet defaultMethods = makeMethods(defaultClient, SUPPORTED_METHODS)\nlet defaultAddon = new Stremio.Server(defaultMethods, MANIFEST)\n\n// Cache for per-user PornClient instances (keyed by config string)\nlet userClients = {}\nlet userClientKeys = []\nconst MAX_USER_CLIENTS = 100\n\nfunction getClientForConfig(configStr) {\n  if (!configStr) {\n    return defaultClient\n  }\n\n  if (userClients[configStr]) {\n    return userClients[configStr]\n  }\n\n  let userConfig = parseUserConfig(configStr)\n\n  if (!userConfig.realDebridToken && !userConfig.torboxToken) {\n    return defaultClient\n  }\n\n  let clientOptions = {\n    ...baseClientOptions,\n    realDebridToken: userConfig.realDebridToken,\n    torboxToken: userConfig.torboxToken,\n  }\n\n  let client = new PornClient(clientOptions)\n  userClients[configStr] = client\n  userClientKeys.push(configStr)\n\n  // Evict oldest entries when cache exceeds limit\n  while (userClientKeys.length > MAX_USER_CLIENTS) {\n    let oldKey = userClientKeys.shift()\n    delete userClients[oldKey]\n  }\n\n  return client\n}\n\nlet server = http.createServer((req, res) => {\n  // Handle user-configured addon routes: /<base64config>/stremioget/stremio/v1\n  // Uses URL-safe base64 (- and _ instead of + and /)\n  let configMatch = req.url.match(\n    /^\\/([A-Za-z0-9_-]+=*)\\/stremioget\\//\n  )\n  let configStr = configMatch ? configMatch[1] : null\n\n  if (configStr) {\n    let client = getClientForConfig(configStr)\n    let methods = makeMethods(client, SUPPORTED_METHODS)\n    let configuredManifest = {\n      ...MANIFEST,\n      endpoint: `${ENDPOINT}/${configStr}/stremioget/stremio/v1`,\n    }\n    let configuredAddon = new Stremio.Server(methods, configuredManifest)\n    // Rewrite URL to remove the config prefix\n    // so the Stremio server can handle it\n    req.url = req.url.slice(configStr.length + 1)\n    configuredAddon.middleware(req, res, () => res.end())\n    return\n  }\n\n  if (req.url === '/api/status') {\n    let status = {\n      manifest: {\n        name: MANIFEST.name,\n        version: MANIFEST.version,\n        description: MANIFEST.description,\n        catalogs: MANIFEST.catalogs,\n        dontAnnounce: MANIFEST.dontAnnounce,\n      },\n      config: {\n        cache: CACHE !== '0',\n        proxy: !!PROXY,\n      },\n    }\n    res.writeHead(200, { 'Content-Type': 'application/json' })\n    res.end(JSON.stringify(status))\n    return\n  }\n  serveStatic(STATIC_DIR)(req, res, () => {\n    defaultAddon.middleware(req, res, () => res.end())\n  })\n})\n\nserver\n  .on('listening', () => {\n    let values = {\n      endpoint: chalk.green(MANIFEST.endpoint),\n      id: ID === DEFAULT_ID ? chalk.red(ID) : chalk.green(ID),\n      email: EMAIL ? chalk.green(EMAIL) : chalk.red('undefined'),\n      env: IS_PROD ? chalk.green('production') : chalk.green('development'),\n      proxy: PROXY ? chalk.green(PROXY) : chalk.red('off'),\n      cache: (CACHE === '0') ?\n        chalk.red('off') :\n        chalk.green('on'),\n    }\n\n    // eslint-disable-next-line no-console\n    console.log(`\n    ${MANIFEST.name} Addon is listening on port ${PORT}\n\n    Endpoint:    ${values.endpoint}\n    Addon Id:    ${values.id}\n    Email:       ${values.email}\n    Environment: ${values.env}\n    Proxy:       ${values.proxy}\n    Cache:       ${values.cache}\n    `)\n  })\n  .listen(PORT)\n\n\nexport default server\n"],"file":"index.js"}