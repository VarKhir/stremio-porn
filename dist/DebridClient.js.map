{"version":3,"sources":["../src/DebridClient.js"],"names":["DebridClient","constructor","httpClient","options","realDebridToken","torboxToken","torboxEndpoint","torboxCacheEndpoint","isEnabled","Boolean","_encodeForm","params","Object","keys","filter","key","undefined","map","encodeURIComponent","join","_pickUrl","body","download","link","location","data","_checkTorboxCache","url","encoded","checkUrl","request","headers","Authorization","json","cached","err","_unrestrictWithRealDebrid","method","_unrestrictWithTorbox","isCached","_unrestrict","directUrl","service","unrestrictStreams","streams","Array","isArray","Promise","all","stream","result","tag","name"],"mappings":";;;;;;;;;;;;;AAAA,MAAMA,YAAN,CAAmB;AACjBC,cAAYC,UAAZ,EAAwBC,UAAU,EAAlC,EAAsC;AACpC,SAAKD,UAAL,GAAkBA,UAAlB;AACA,SAAKE,eAAL,GAAuBD,QAAQC,eAA/B;AACA,SAAKC,WAAL,GAAmBF,QAAQE,WAA3B;AACA,SAAKC,cAAL,GAAsB,yCAAtB;AACA,SAAKC,mBAAL,GAA2B,iDAA3B;AACD;;AAED,MAAIC,SAAJ,GAAgB;AACd,WAAOC,QAAQ,KAAKL,eAAL,IAAwB,KAAKC,WAArC,CAAP;AACD;;AAEDK,cAAYC,SAAS,EAArB,EAAyB;AACvB,WAAOC,OAAOC,IAAP,CAAYF,MAAZ,EACJG,MADI,CACIC,GAAD,IAASJ,OAAOI,GAAP,MAAgB,IAAhB,IAAwBJ,OAAOI,GAAP,MAAgBC,SADpD,EAEJC,GAFI,CAECF,GAAD,IAAU,GAAEG,mBAAmBH,GAAnB,CAAwB,IAAGG,mBAAmBP,OAAOI,GAAP,CAAnB,CAAgC,EAFvE,EAGJI,IAHI,CAGC,GAHD,CAAP;AAID;;AAEDC,WAASC,IAAT,EAAe;AACb,QAAI,CAACA,IAAD,IAAS,OAAOA,IAAP,KAAgB,QAA7B,EAAuC;AACrC,aAAO,IAAP;AACD;;AAED,QAAI,OAAOA,KAAKC,QAAZ,KAAyB,QAA7B,EAAuC;AACrC,aAAOD,KAAKC,QAAZ;AACD;;AAED,QAAI,OAAOD,KAAKE,IAAZ,KAAqB,QAAzB,EAAmC;AACjC,aAAOF,KAAKE,IAAZ;AACD;;AAED,QAAI,OAAOF,KAAKG,QAAZ,KAAyB,QAA7B,EAAuC;AACrC,aAAOH,KAAKG,QAAZ;AACD;;AAED,QAAIH,KAAKI,IAAL,IAAa,OAAOJ,KAAKI,IAAZ,KAAqB,QAAtC,EAAgD;AAC9C,aAAO,KAAKL,QAAL,CAAcC,KAAKI,IAAnB,CAAP;AACD;;AAED,WAAO,IAAP;AACD;;AAEKC,mBAAN,CAAwBC,GAAxB,EAA6B;AAAA;;AAAA;AAC3B,UAAI,CAAC,MAAKtB,WAAN,IAAqB,CAACsB,GAA1B,EAA+B;AAC7B,eAAO,IAAP;AACD;;AAED,UAAI;AACF,YAAIC,UAAUV,mBAAmBS,GAAnB,CAAd;AACA,YAAIE,WAAY,GAAE,MAAKtB,mBAAoB,QAAOqB,OAAQ,EAA1D;AACA,YAAI;AAAEP;AAAF,kBAAiB,MAAKnB,UAAL,CAAgB4B,OAAhB,CAAwBD,QAAxB,EAAkC;AACrDE,mBAAS;AACPC,2BAAgB,UAAS,MAAK3B,WAAY;AADnC,WAD4C;AAIrD4B,gBAAM;AAJ+C,SAAlC,CAArB;;AAOA,YAAIZ,QAAQA,KAAKI,IAAb,IAAqBJ,KAAKI,IAAL,CAAUS,MAAV,KAAqB,IAA9C,EAAoD;AAClD,iBAAO,IAAP;AACD;;AAED,eAAO,KAAP;AACD,OAfD,CAeE,OAAOC,GAAP,EAAY;AACZ,eAAO,IAAP;AACD;AAtB0B;AAuB5B;;AAEKC,2BAAN,CAAgCT,GAAhC,EAAqC;AAAA;;AAAA;AACnC,UAAI,CAAC,OAAKvB,eAAV,EAA2B;AACzB,eAAO,IAAP;AACD;;AAED,UAAI;AACF,YAAI;AAAEiB;AAAF,kBAAiB,OAAKnB,UAAL,CAAgB4B,OAAhB,CACnB,sDADmB,EAEnB;AACEO,kBAAQ,MADV;AAEEN,mBAAS;AACPC,2BAAgB,UAAS,OAAK5B,eAAgB,EADvC;AAEP,4BAAgB;AAFT,WAFX;AAMEiB,gBAAM,OAAKX,WAAL,CAAiB;AAAEa,kBAAMI;AAAR,WAAjB,CANR;AAOEM,gBAAM;AAPR,SAFmB,CAArB;AAYA,eAAO,OAAKb,QAAL,CAAcC,IAAd,CAAP;AACD,OAdD,CAcE,OAAOc,GAAP,EAAY;AACZ,eAAO,IAAP;AACD;AArBkC;AAsBpC;;AAEKG,uBAAN,CAA4BX,GAA5B,EAAiC;AAAA;;AAAA;AAC/B,UAAI,CAAC,OAAKtB,WAAV,EAAuB;AACrB,eAAO,IAAP;AACD;;AAED,UAAI;AACF,YAAIkC,iBAAiB,OAAKb,iBAAL,CAAuBC,GAAvB,CAArB;;AAEA,YAAIY,aAAa,KAAjB,EAAwB;AACtB,iBAAO,IAAP;AACD;;AAED,YAAI;AAAElB;AAAF,kBAAiB,OAAKnB,UAAL,CAAgB4B,OAAhB,CAAwB,OAAKxB,cAA7B,EAA6C;AAChE+B,kBAAQ,MADwD;AAEhEN,mBAAS;AACPC,2BAAgB,UAAS,OAAK3B,WAAY,EADnC;AAEP,4BAAgB;AAFT,WAFuD;AAMhEgB,gBAAM,OAAKX,WAAL,CAAiB;AAAEiB;AAAF,WAAjB,CAN0D;AAOhEM,gBAAM;AAP0D,SAA7C,CAArB;AASA,eAAO,OAAKb,QAAL,CAAcC,IAAd,CAAP;AACD,OAjBD,CAiBE,OAAOc,GAAP,EAAY;AACZ,eAAO,IAAP;AACD;AAxB8B;AAyBhC;;AAEKK,aAAN,CAAkBb,GAAlB,EAAuB;AAAA;;AAAA;AACrB,UAAI,CAACA,GAAD,IAAQ,CAAC,OAAKnB,SAAlB,EAA6B;AAC3B,eAAO,IAAP;AACD;;AAED,UAAIiC,kBAAkB,OAAKL,yBAAL,CAA+BT,GAA/B,CAAtB;;AAEA,UAAIc,SAAJ,EAAe;AACb,eAAO;AAAEd,eAAKc,SAAP;AAAkBC,mBAAS;AAA3B,SAAP;AACD;;AAEDD,wBAAkB,OAAKH,qBAAL,CAA2BX,GAA3B,CAAlB;;AAEA,UAAIc,SAAJ,EAAe;AACb,eAAO;AAAEd,eAAKc,SAAP;AAAkBC,mBAAS;AAA3B,SAAP;AACD;;AAED,aAAO,IAAP;AAjBqB;AAkBtB;;AAEKC,mBAAN,CAAwBC,OAAxB,EAAiC;AAAA;;AAAA;AAC/B,UAAI,CAACC,MAAMC,OAAN,CAAcF,OAAd,CAAD,IAA2B,CAAC,OAAKpC,SAArC,EAAgD;AAC9C,eAAOoC,WAAW,EAAlB;AACD;;AAED,aAAOG,QAAQC,GAAR,CAAYJ,QAAQ3B,GAAR;AAAA;AAAA;AAAA,qCAAY,WAAOgC,MAAP,EAAkB;AAC/C,cAAI,CAACA,MAAD,IAAW,CAACA,OAAOtB,GAAvB,EAA4B;AAC1B,mBAAOsB,MAAP;AACD;;AAED,cAAIC,eAAe,OAAKV,WAAL,CAAiBS,OAAOtB,GAAxB,CAAnB;;AAEA,cAAIuB,UAAUA,OAAOvB,GAAP,KAAesB,OAAOtB,GAApC,EAAyC;AACvC,gBAAIwB,MAAMD,OAAOR,OAAP,KAAmB,IAAnB,GACR,QADQ,GACI,IAAGQ,OAAOR,OAAQ,GADhC;AAEA,qCACKO,MADL;AAEEtB,mBAAKuB,OAAOvB,GAFd;AAGEyB,oBAAO,GAAED,GAAI,IAAGF,OAAOG,IAAP,IAAe,QAAS;AAH1C;AAKD,WARD,MAQO;AACL,mBAAOH,MAAP;AACD;AACF,SAlBkB;;AAAA;AAAA;AAAA;AAAA,UAAZ,CAAP;AAL+B;AAwBhC;;AApKgB;;eAwKJjD,Y","sourcesContent":["class DebridClient {\n  constructor(httpClient, options = {}) {\n    this.httpClient = httpClient\n    this.realDebridToken = options.realDebridToken\n    this.torboxToken = options.torboxToken\n    this.torboxEndpoint = 'https://api.torbox.app/v1/links/instant'\n    this.torboxCacheEndpoint = 'https://api.torbox.app/v1/api/webdl/checkcached'\n  }\n\n  get isEnabled() {\n    return Boolean(this.realDebridToken || this.torboxToken)\n  }\n\n  _encodeForm(params = {}) {\n    return Object.keys(params)\n      .filter((key) => params[key] !== null && params[key] !== undefined)\n      .map((key) => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)\n      .join('&')\n  }\n\n  _pickUrl(body) {\n    if (!body || typeof body !== 'object') {\n      return null\n    }\n\n    if (typeof body.download === 'string') {\n      return body.download\n    }\n\n    if (typeof body.link === 'string') {\n      return body.link\n    }\n\n    if (typeof body.location === 'string') {\n      return body.location\n    }\n\n    if (body.data && typeof body.data === 'object') {\n      return this._pickUrl(body.data)\n    }\n\n    return null\n  }\n\n  async _checkTorboxCache(url) {\n    if (!this.torboxToken || !url) {\n      return null\n    }\n\n    try {\n      let encoded = encodeURIComponent(url)\n      let checkUrl = `${this.torboxCacheEndpoint}?url=${encoded}`\n      let { body } = await this.httpClient.request(checkUrl, {\n        headers: {\n          Authorization: `Bearer ${this.torboxToken}`,\n        },\n        json: true,\n      })\n\n      if (body && body.data && body.data.cached === true) {\n        return true\n      }\n\n      return false\n    } catch (err) {\n      return null\n    }\n  }\n\n  async _unrestrictWithRealDebrid(url) {\n    if (!this.realDebridToken) {\n      return null\n    }\n\n    try {\n      let { body } = await this.httpClient.request(\n        'https://api.real-debrid.com/rest/1.0/unrestrict/link',\n        {\n          method: 'POST',\n          headers: {\n            Authorization: `Bearer ${this.realDebridToken}`,\n            'Content-Type': 'application/x-www-form-urlencoded',\n          },\n          body: this._encodeForm({ link: url }),\n          json: true,\n        }\n      )\n      return this._pickUrl(body)\n    } catch (err) {\n      return null\n    }\n  }\n\n  async _unrestrictWithTorbox(url) {\n    if (!this.torboxToken) {\n      return null\n    }\n\n    try {\n      let isCached = await this._checkTorboxCache(url)\n\n      if (isCached === false) {\n        return null\n      }\n\n      let { body } = await this.httpClient.request(this.torboxEndpoint, {\n        method: 'POST',\n        headers: {\n          Authorization: `Bearer ${this.torboxToken}`,\n          'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: this._encodeForm({ url }),\n        json: true,\n      })\n      return this._pickUrl(body)\n    } catch (err) {\n      return null\n    }\n  }\n\n  async _unrestrict(url) {\n    if (!url || !this.isEnabled) {\n      return null\n    }\n\n    let directUrl = await this._unrestrictWithRealDebrid(url)\n\n    if (directUrl) {\n      return { url: directUrl, service: 'RD' }\n    }\n\n    directUrl = await this._unrestrictWithTorbox(url)\n\n    if (directUrl) {\n      return { url: directUrl, service: 'TB' }\n    }\n\n    return null\n  }\n\n  async unrestrictStreams(streams) {\n    if (!Array.isArray(streams) || !this.isEnabled) {\n      return streams || []\n    }\n\n    return Promise.all(streams.map(async (stream) => {\n      if (!stream || !stream.url) {\n        return stream\n      }\n\n      let result = await this._unrestrict(stream.url)\n\n      if (result && result.url !== stream.url) {\n        let tag = result.service === 'TB' ?\n          '[TB] âš¡' : `[${result.service}]`\n        return {\n          ...stream,\n          url: result.url,\n          name: `${tag} ${stream.name || 'Debrid'}`,\n        }\n      } else {\n        return stream\n      }\n    }))\n  }\n}\n\n\nexport default DebridClient\n"],"file":"DebridClient.js"}